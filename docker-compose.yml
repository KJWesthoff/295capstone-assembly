services:
  # Nginx Reverse Proxy (for Railway deployment)
  nginx:
    image: nginx:alpine
    container_name: ventiapi-nginx
    ports:
      - "3000:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - frontend-build:/usr/share/nginx/html
    networks:
      - scanner-network
    depends_on:
      - frontend
      - web-api

  # Frontend React App (build only)
  frontend:
    build: ./frontend
    container_name: ventiapi-frontend
    volumes:
      - frontend-build:/shared
    networks:
      - scanner-network

  # Web API Backend
  web-api:
    build: ./scanner-service/web-api
    container_name: ventiapi-web-api
    expose:
      - "8000"
    volumes:
      - shared-results:/shared/results
      - shared-specs:/shared/specs
      - /var/run/docker.sock:/var/run/docker.sock  # Access to Docker daemon
    networks:
      - scanner-network
    env_file:
      - .env.local
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - redis

  # Redis for job queue and caching (optional but recommended)
  redis:
    image: redis:7-alpine
    container_name: ventiapi-redis
    ports:
      - "6379:6379"
    networks:
      - scanner-network
    volumes:
      - redis-data:/data

  # Scanner service (builds the image for web-api to use)
  scanner:
    build:
      context: .
      dockerfile: scanner.Dockerfile
    image: ventiapi-scanner
    container_name: ventiapi-scanner-builder
    volumes:
      - shared-results:/shared/results
      - shared-specs:/shared/specs
    networks:
      - scanner-network
    environment:
      - PYTHONUNBUFFERED=1
    command: ["echo", "Scanner image built"]
    profiles: ["build-only"]  # Only runs when explicitly requested

  # Scanner Worker (for job queue mode - optional for local dev)
  scanner-worker:
    build:
      context: .
      dockerfile: scanner-worker.Dockerfile
    volumes:
      - shared-results:/shared/results
      - shared-specs:/shared/specs
    networks:
      - scanner-network
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis
    profiles: ["jobqueue"]  # Only runs in job queue mode
    scale: 2  # Run 2 workers by default

  # ZAP Scanner (builds the image for web-api to use)
  zap:
    build:
      context: .
      dockerfile: zap.Dockerfile
    image: ventiapi-zap
    container_name: ventiapi-zap-builder
    volumes:
      - shared-results:/zap/wrk:rw
      - shared-specs:/zap/specs:ro
    networks:
      - scanner-network
    command: ["echo", "ZAP scanner image built"]
    profiles: ["build-only"]  # Only runs when explicitly requested

volumes:
  shared-results:
  shared-specs:
  redis-data:
  frontend-build:

networks:
  scanner-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: scanner-br0